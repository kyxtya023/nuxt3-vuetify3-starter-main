import{D as e,F as t}from"./nitro.mjs";function hasProp(e,t){try{return t in e}catch{return!1}}var s=Object.defineProperty,__publicField$2=(e,t,r)=>(((e,t,r)=>{t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r})(e,"symbol"!=typeof t?t+"":t,r),r);class H3Error extends Error{constructor(e,t={}){super(e,t),__publicField$2(this,"statusCode",500),__publicField$2(this,"fatal",!1),__publicField$2(this,"unhandled",!1),__publicField$2(this,"statusMessage"),__publicField$2(this,"data"),__publicField$2(this,"cause"),t.cause&&!this.cause&&(this.cause=t.cause)}toJSON(){const e={message:this.message,statusCode:sanitizeStatusCode(this.statusCode,500)};return this.statusMessage&&(e.statusMessage=sanitizeStatusMessage(this.statusMessage)),void 0!==this.data&&(e.data=this.data),e}}function createError(e){if("string"==typeof e)return new H3Error(e);if(isError(e))return e;const t=new H3Error(e.message??e.statusMessage??"",{cause:e.cause||e});if(hasProp(e,"stack"))try{Object.defineProperty(t,"stack",{get:()=>e.stack})}catch{try{t.stack=e.stack}catch{}}if(e.data&&(t.data=e.data),e.statusCode?t.statusCode=sanitizeStatusCode(e.statusCode,t.statusCode):e.status&&(t.statusCode=sanitizeStatusCode(e.status,t.statusCode)),e.statusMessage?t.statusMessage=e.statusMessage:e.statusText&&(t.statusMessage=e.statusText),t.statusMessage){const e=t.statusMessage;sanitizeStatusMessage(t.statusMessage)!==e&&console.warn("[h3] Please prefer using `message` for longer error messages instead of `statusMessage`. In the future, `statusMessage` will be sanitized by default.")}return void 0!==e.fatal&&(t.fatal=e.fatal),void 0!==e.unhandled&&(t.unhandled=e.unhandled),t}function sendError(e,t,s){if(e.handled)return;const r=isError(t)?t:createError(t),a={statusCode:r.statusCode,statusMessage:r.statusMessage,stack:[],data:r.data};if(e.handled)return;!function(e,t,s){t&&(e.node.res.statusCode=sanitizeStatusCode(t,e.node.res.statusCode));s&&(e.node.res.statusMessage=sanitizeStatusMessage(s))}(e,Number.parseInt(r.statusCode),r.statusMessage),e.node.res.setHeader("content-type",o.json),e.node.res.end(JSON.stringify(a,void 0,2))}function isError(e){return!0===e?.constructor?.__h3_error__}__publicField$2(H3Error,"__h3_error__",!0);const r=Symbol.for("h3RawBody"),a=Symbol.for("h3ParsedBody"),n=["PATCH","POST","PUT","DELETE"];function readRawBody(e,s="utf8"){!function(e,t){if(!function(e,t){if("string"==typeof t){if(e.method===t)return!0}else if(t.includes(e.method))return!0;return!1}(e,t))throw createError({statusCode:405,statusMessage:"HTTP method is not allowed."})}(e,n);const a=e._requestBody||e.web?.request?.body||e.node.req[r]||e.node.req.rawBody||e.node.req.body;if(a){const e=Promise.resolve(a).then((e=>t.isBuffer(e)?e:"function"==typeof e.pipeTo?new Promise(((s,r)=>{const a=[];e.pipeTo(new WritableStream({write(e){a.push(e)},close(){s(t.concat(a))},abort(e){r(e)}})).catch(r)})):"function"==typeof e.pipe?new Promise(((s,r)=>{const a=[];e.on("data",(e=>{a.push(e)})).on("end",(()=>{s(t.concat(a))})).on("error",r)})):e.constructor===Object?t.from(JSON.stringify(e)):e instanceof URLSearchParams?t.from(e.toString()):t.from(e)));return s?e.then((e=>e.toString(s))):e}if(!Number.parseInt(e.node.req.headers["content-length"]||"")&&!String(e.node.req.headers["transfer-encoding"]??"").split(",").map((e=>e.trim())).filter(Boolean).includes("chunked"))return Promise.resolve(void 0);const o=e.node.req[r]=new Promise(((s,r)=>{const a=[];e.node.req.on("error",(e=>{r(e)})).on("data",(e=>{a.push(e)})).on("end",(()=>{s(t.concat(a))}))}));return s?o.then((e=>e.toString(s))):o}async function readBody(e,t={}){const s=e.node.req;if(hasProp(s,a))return s[a];const r=s.headers["content-type"]||"",n=await readRawBody(e);let o;return o="application/json"===r?_parseJSON(n,t.strict??!0):r.startsWith("application/x-www-form-urlencoded")?function(e){const t=new URLSearchParams(e),s=Object.create(null);for(const[e,r]of t.entries())hasProp(s,e)?(Array.isArray(s[e])||(s[e]=[s[e]]),s[e].push(r)):s[e]=r;return s}(n):r.startsWith("text/")?n:_parseJSON(n,t.strict??!1),s[a]=o,o}function _parseJSON(t="",s){if(t)try{return e(t,{strict:s})}catch{throw createError({statusCode:400,statusMessage:"Bad Request",message:"Invalid JSON body"})}}const o={html:"text/html",json:"application/json"},i=/[^\u0009\u0020-\u007E]/g;function sanitizeStatusMessage(e=""){return e.replace(i,"")}function sanitizeStatusCode(e,t=200){return e?("string"==typeof e&&(e=Number.parseInt(e,10)),e<100||e>999?t:e):t}function defineEventHandler(e){if("function"==typeof e)return e.__is_handler__=!0,e;const t={onRequest:_normalizeArray(e.onRequest),onBeforeResponse:_normalizeArray(e.onBeforeResponse)},_handler=s=>async function(e,t,s){if(s.onRequest)for(const t of s.onRequest)if(await t(e),e.handled)return;const r=await t(e),a={body:r};if(s.onBeforeResponse)for(const t of s.onBeforeResponse)await t(e,a);return a.body}(s,e.handler,t);return _handler.__is_handler__=!0,_handler.__resolve__=e.handler.__resolve__,_handler.__websocket__=e.websocket,_handler}function _normalizeArray(e){return e?Array.isArray(e)?e:[e]:void 0}"undefined"==typeof setImmediate||setImmediate;export{sanitizeStatusCode as a,createError as c,defineEventHandler as d,readBody as r,sendError as s};
//# sourceMappingURL=index.mjs.map
